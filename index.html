<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equatino! Bingo App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f9fafb;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .bingo-cell {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease-in-out;
        }
        .bingo-cell.marked {
            background-color: #06b6d4;
            transform: scale(0.9);
            color: #ffffff;
            font-weight: 900;
        }
        @keyframes bingo-animation {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .bingo-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .bingo-text {
            font-size: 10vw; font-weight: 900; color: #22d3ee;
            text-shadow: 0 0 10px #fff, 0 0 20px #22d3ee;
            animation: bingo-animation 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- DO NOT EDIT: These are automatically provided by the environment ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // ---

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.initialAuthToken = initialAuthToken;
        window.firebase = {
            doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, query,
            signInAnonymously, signInWithCustomToken
        };
        
        // This signals that Firebase is ready, so React can render
        document.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, StrictMode } = React;

        // --- CONFIGURATION ---
        const BINGO_MIN_NUMBER = 1;
        const BINGO_MAX_NUMBER = 75;
        const GRID_SIZE = 5;

        // --- HELPER FUNCTIONS ---
        function createSeededRandom(seed) {
            let h = 1779033703 ^ seed.length;
            for (let i = 0; i < seed.length; i++) {
                h = Math.imul(h ^ seed.charCodeAt(i), 3432918353);
                h = h << 13 | h >>> 19;
            }
            return function() {
                h = Math.imul(h ^ h >>> 16, 2246822507);
                h = Math.imul(h ^ h >>> 13, 3266489909);
                return (h ^= h >>> 16) >>> 0;
            }
        }

        function getShuffledNumbers(randomFunc, min, max) {
            const allNumbers = Array.from({ length: max - min + 1 }, (_, i) => i + min);
            for (let i = allNumbers.length - 1; i > 0; i--) {
                const j = randomFunc() % (i + 1);
                [allNumbers[i], allNumbers[j]] = [allNumbers[j], allNumbers[i]];
            }
            return allNumbers;
        }
        
        const winningCombos = [
            // Rows
            [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
            // Cols
            [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
            // Diagonals
            [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
        ];

        // --- REACT COMPONENTS ---

        const BingoAnimation = () => (
            <div className="bingo-overlay fade-in">
                <div className="bingo-text">BINGO!</div>
            </div>
        );

        const ParticipantView = ({ seed }) => {
            const [cardNumbers, setCardNumbers] = useState([]);
            const [markedIndices, setMarkedIndices] = useState(new Set([12])); // 12 is the center FREE space
            const [isBingo, setIsBingo] = useState(false);

            useEffect(() => {
                const randomFunc = createSeededRandom(seed);
                const shuffled = getShuffledNumbers(randomFunc, BINGO_MIN_NUMBER, BINGO_MAX_NUMBER);
                setCardNumbers(shuffled.slice(0, GRID_SIZE * GRID_SIZE - 1));
            }, [seed]);

            const checkBingo = (currentMarks) => {
                for (const combo of winningCombos) {
                    if (combo.every(index => currentMarks.has(index))) {
                        return true;
                    }
                }
                return false;
            };

            const toggleMark = (index) => {
                if (isBingo) return; // Don't allow changes after bingo
                const newMarks = new Set(markedIndices);
                if (newMarks.has(index)) {
                    newMarks.delete(index);
                } else {
                    newMarks.add(index);
                }
                setMarkedIndices(newMarks);
                if (checkBingo(newMarks)) {
                    setIsBingo(true);
                }
            };
            
            const renderCell = (cellIndex) => {
                const isCenter = cellIndex === 12;
                const number = isCenter ? "FREE" : cardNumbers[cellIndex > 12 ? cellIndex - 1 : cellIndex];
                const isMarked = markedIndices.has(cellIndex);

                return (
                    <div 
                        key={cellIndex}
                        className={`bingo-cell flex items-center justify-center text-xl md:text-2xl font-bold rounded-md bg-gray-900 aspect-square ${isMarked ? 'marked' : ''}`}
                        onClick={() => toggleMark(cellIndex)}
                    >
                        {number}
                    </div>
                );
            };

            if (cardNumbers.length === 0) return <div>Loading Card...</div>;

            return (
                <div className="w-full max-w-md text-center">
                    {isBingo && <BingoAnimation />}
                    <div className="mb-4">
                        <h1 className="text-5xl font-black tracking-tight text-cyan-400">Equatino!</h1>
                        <p className="text-gray-400 mt-1">Tap the squares you solve!</p>
                    </div>
                    <div className="fade-in grid grid-cols-5 gap-2 bg-gray-800 p-3 rounded-lg shadow-2xl w-full aspect-square">
                        {Array.from({ length: 25 }).map((_, i) => renderCell(i))}
                    </div>
                    <p className="text-gray-500 text-xs mt-4">Card ID: <span id="card-id">{seed}</span></p>
                </div>
            );
        };

        const AdminView = () => {
            const [cards, setCards] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // CORRECTED PATH: This now correctly points to the collection of cards.
                const cardsCollectionRef = window.firebase.collection(window.db, `/artifacts/${window.appId}/public/data/equatino-cards`);
                const q = window.firebase.query(cardsCollectionRef);

                const unsubscribe = window.firebase.onSnapshot(q, (querySnapshot) => {
                    const cardsData = [];
                    querySnapshot.forEach((doc) => {
                        cardsData.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort by creation time to show newest cards first
                    cardsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setCards(cardsData);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleTeamNameChange = (cardId, newName) => {
                const cardDocPath = `/artifacts/${window.appId}/public/data/equatino-cards/${cardId}`;
                const docRef = window.firebase.doc(window.db, cardDocPath);
                window.firebase.updateDoc(docRef, { teamName: newName });
            };
            
            if (loading) return <div>Loading Admin Panel...</div>;

            return (
                <div className="w-full max-w-4xl mx-auto text-center p-4">
                    <h1 className="text-4xl font-bold text-cyan-400 mb-6">Admin Dashboard</h1>
                    <div className="bg-gray-800 rounded-lg shadow-xl p-4 overflow-x-auto">
                        <div className="grid grid-cols-2 font-bold text-gray-400 border-b border-gray-700 pb-2 mb-2">
                            <span className="text-left">Card ID (Seed)</span>
                            <span className="text-left">Team Name</span>
                        </div>
                        {cards.length === 0 && <p className="text-gray-500 py-4">No cards have been generated yet.</p>}
                        {cards.map(card => (
                            <div key={card.id} className="grid grid-cols-2 items-center py-2 border-b border-gray-700/50">
                                <span className="font-mono text-cyan-400 text-sm truncate text-left">{card.id}</span>
                                <input
                                    type="text"
                                    defaultValue={card.teamName || ''}
                                    onBlur={(e) => handleTeamNameChange(card.id, e.target.value)}
                                    placeholder="Enter team name..."
                                    className="bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                />
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const OrganizerView = () => {
            const [generatedUrl, setGeneratedUrl] = useState('');
            const [showQr, setShowQr] = useState(false);

            // This effect runs whenever 'generatedUrl' changes to create the QR code.
            useEffect(() => {
                if (generatedUrl) {
                    const qrcodeDiv = document.getElementById('qrcode');
                    if (qrcodeDiv) {
                        qrcodeDiv.innerHTML = ''; // Clear previous QR code
                        new QRCode(qrcodeDiv, { text: generatedUrl, width:
