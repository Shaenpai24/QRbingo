<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equatino! Bingo App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f9fafb;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .bingo-cell {
            user-select: none;
            transition: all 0.2s ease-in-out;
        }
        .bingo-cell.marked {
            background-color: #06b6d4;
            transform: scale(0.9);
            color: #ffffff;
            font-weight: 900;
        }
        .bingo-cell.clickable:hover {
            background-color: #0891b2;
            transform: scale(1.05);
            cursor: pointer;
        }
        .admin-card .bingo-cell {
            font-size: 0.7rem;
            line-height: 1;
            font-weight: bold;
        }
        .admin-card .bingo-cell.marked {
             background-color: #f59e0b;
        }
        @keyframes bingo-animation {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .bingo-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .bingo-text {
            font-size: 10vw; font-weight: 900; color: #22d3ee;
            text-shadow: 0 0 10px #fff, 0 0 20px #22d3ee;
            animation: bingo-animation 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        .question-modal {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        .confirmation-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, query, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBP2pYBRM4Eri0AJr4iZ2P7b08Cs6pTrtg",
          authDomain: "qr-gen-637fb.firebaseapp.com",
          projectId: "qr-gen-637fb",
          storageBucket: "qr-gen-637fb.appspot.com",
          messagingSenderId: "146967798778",
          appId: "1:1469677a8778:web:55f179f4ae3f3916f6ba43",
          measurementId: "G-1F0XF63NJP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.firebase = {
            doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, query, writeBatch, deleteDoc, getDocs,
            signInAnonymously
        };
        
        document.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, StrictMode, useRef } = React;

        // --- GAME CONFIGURATION AND DATA ---
        const BINGO_MAX_NUMBER = 25;
        const QUESTION_TIME_LIMIT = 120;
        const LINES_TO_WIN = 5;
        const ADMIN_PASSWORD = "equatino2025";

        // --- Custom Ordered Question Bank ---
        const ALL_QUESTIONS = [
            { id: 1, text: "A number exceeds 4/7 of itself by 12. What is the number?", correctAnswer: "28" },
            { id: 2, text: "In a right-angled triangle, if sin(A) = 3/5, what is the value of (sec(A) + tan(A))²?", correctAnswer: "4" },
            { id: 3, text: "Find the 2-digit palindrome number which is also a palindrome when doubled.", correctAnswer: "22" },
            { id: 4, text: "Solve for x: 3^(x-18) = 243", correctAnswer: "23" },
            { id: 6, text: "A cube has a volume of 512 cubic units. What is the length of one of its edges?", correctAnswer: "8" },
            { id: 7, text: "If log₃(x) = 2, what is the value of log₃(x³) + log₃(√x)?", correctAnswer: "7" },
            { id: 8, "text": "A regular dodecagon has 12 sides. What is this number of sides minus 3?", correctAnswer: "9" },
            { id: 9, text: "Calculate the value of: [ (2 * sin(60°)) / cos(30°) ] + cot(45°)", correctAnswer: "3" },
            { id: 10, text: "A sphere has a volume of (16384 * π) / 3 cubic units. What is its radius?", correctAnswer: "16" },
            { id: 11, text: "Find the mean of the numbers: 832, 1024, 1100, 900, 756, 980, 1040, 870, 998, 3500. Then, divide the result by 100.", correctAnswer: "12" },
            { id: 14, text: "A bag contains 2 red, 5 blue, and 8 green balls. In how many ways can you draw 1 red and 1 blue ball?", correctAnswer: "10" },
            { id: 15, text: "Evaluate the expression: [((6 ÷ 3) + (4 − 2)) × 2] ÷ 8", correctAnswer: "1" },
            { id: 17, text: "The lateral surface area of a cylinder is 176π square units. If its height is 8 units, what is its radius?", correctAnswer: "11" },
            { id: 18, text: "Ten years ago, a father was 4 times as old as his son. Their current age difference is 21 years. What is the son's current age?", correctAnswer: "17" },
            { id: 19, text: "What is the focal length of the parabola defined by the equation y² = 20x?", correctAnswer: "5" },
            { id: 20, text: "A 7-sided regular polygon (a heptagon) has how many diagonals?", correctAnswer: "14" },
            { id: 21, text: "In a pie chart of monthly expenses, the angle for groceries is 72°. What percentage of the total expenses does this represent?", correctAnswer: "20" },
            { id: 22, text: "If matrix A = [[2, 1], [3, 4]] is multiplied by the identity matrix I = [[1, 0], [0, 1]], what is the top-left element of the resulting matrix?", correctAnswer: "2" },
            { id: 24, text: "A library has 95,000 books. If 0.02% of them are rare ancient manuscripts, how many rare manuscripts are there?", correctAnswer: "19" }
        ];
        
        const createFinalQuestionOrder = () => {
            const fixedAnswers = ["13", "18", "8", "15", "25", "6"];
            
            const finalFixedQuestions = [
                { id: 5, text: "What is the smallest prime number greater than 11?", correctAnswer: "13" },
                { id: 13, text: "What is 3 multiplied by 6?", correctAnswer: "18" },
                ALL_QUESTIONS.find(q => q.correctAnswer === "8"),
                { id: 23, text: "Calculate the value of: 5 * sin(30°) * csc(30°) * tan(60°) * cot(30°)", correctAnswer: "15" },
                { id: 16, text: "Compute the determinant of the matrix [[2, 3, 1], [4, 1, 2], [1, 2, 3]] and then take its absolute value (remove the negative sign).", correctAnswer: "25" },
                { id: 12, text: "How many distinct positive divisors does the number 60 have?", correctAnswer: "6" },
            ];

            let finalRemaining = ALL_QUESTIONS.filter(q => !fixedAnswers.includes(q.correctAnswer));
            
            for (let i = finalRemaining.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [finalRemaining[i], finalRemaining[j]] = [finalRemaining[j], finalRemaining[i]];
            }

            return [...finalFixedQuestions, ...finalRemaining];
        };

        const QUESTIONS_DATA = createFinalQuestionOrder();


        const winningCombos = [
            [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
            [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
            [0,6,12,18,24], [4,8,12,16,20]
        ];

        function createSeededRandom(seed) { /* ... same as before ... */ }

        const BingoAnimation = () => ( <div className="bingo-overlay fade-in"><div className="bingo-text">BINGO!</div></div> );

        const QuestionModal = ({ question, timeLeft, activeQuestionId }) => { /* ... same as before ... */ };

        const ConfirmationModal = ({ submission, onConfirm, onCancel }) => { /* ... same as before ... */ };
        
        const ParticipantView = ({ seed }) => { /* ... same as before ... */ };

        const AdminBingoCard = ({ numbers, markedIndices }) => { /* ... same as before ... */ };
        
        const GameControlPanel = ({ onResetGame, isResetting }) => {
            const [gameState, setGameState] = useState({ questionIndex: -1 });
            const [timeLeft, setTimeLeft] = useState(0);
            const [isConfirmingAction, setIsConfirmingAction] = useState(false);

            useEffect(() => {
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                const unsubscribe = window.firebase.onSnapshot(gameStateRef, (doc) => {
                    if(doc.exists()) {
                        setGameState(doc.data());
                    } else {
                        setGameState({ activeQuestionId: null, questionIndex: -1 });
                    }
                });
                return () => unsubscribe();
            }, []);

             useEffect(() => {
                if (gameState && gameState.endTime) {
                    const updateTimer = () => {
                        const now = Date.now();
                        const end = gameState.endTime.toDate().getTime();
                        const secondsLeft = Math.max(0, Math.floor((end - now) / 1000));
                        setTimeLeft(secondsLeft);
                        if (secondsLeft === 0) clearInterval(timerInterval);
                    };
                    updateTimer();
                    const timerInterval = setInterval(updateTimer, 1000);
                    return () => clearInterval(timerInterval);
                } else {
                    setTimeLeft(0);
                }
            }, [gameState.endTime]);
            
            const handleStartGame = async () => {
                if (!isConfirmingAction) {
                    setIsConfirmingAction(true);
                    setTimeout(() => setIsConfirmingAction(false), 3000);
                    return;
                }

                const firstQuestion = QUESTIONS_DATA[0];
                const endTime = new Date(Date.now() + QUESTION_TIME_LIMIT * 1000);
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                
                await window.firebase.setDoc(gameStateRef, {
                    activeQuestionId: firstQuestion.id,
                    questionIndex: 0,
                    endTime: endTime
                }, { merge: true });

                setIsConfirmingAction(false);
            };

            const handleNextQuestion = async () => {
                if (!isConfirmingAction) {
                    setIsConfirmingAction(true);
                    setTimeout(() => setIsConfirmingAction(false), 3000);
                    return;
                }

                const currentIndex = gameState.questionIndex ?? -1;
                const nextIndex = currentIndex + 1;

                if (nextIndex >= QUESTIONS_DATA.length) {
                    alert("End of questions!");
                    setIsConfirmingAction(false);
                    return;
                }

                const nextQuestion = QUESTIONS_DATA[nextIndex];
                const endTime = new Date(Date.now() + QUESTION_TIME_LIMIT * 1000);
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                
                await window.firebase.setDoc(gameStateRef, {
                    activeQuestionId: nextQuestion.id,
                    questionIndex: nextIndex,
                    endTime: endTime
                }, { merge: true });

                setIsConfirmingAction(false);
            };

            const handleDeactivate = async () => {
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                await window.firebase.updateDoc(gameStateRef, { activeQuestionId: null, endTime: null });
            };
            
            const isGameStarted = (gameState.questionIndex ?? -1) >= 0;
            const currentQuestionIndex = gameState.questionIndex ?? -1;
            const nextQuestionNumber = currentQuestionIndex + 2;

            return (
                <div className="bg-gray-900 p-4 rounded-lg mb-6 shadow-lg">
                    <h2 className="text-2xl font-bold text-center mb-4">Game Controls</h2>
                    <div className="flex flex-wrap items-center justify-center gap-4">
                        {!isGameStarted ? (
                             <button 
                                onClick={handleStartGame} 
                                className={`font-bold py-2 px-4 rounded-lg ${isConfirmingAction ? 'bg-green-700' : 'bg-green-500 hover:bg-green-600'} text-white`}
                            >
                                {isConfirmingAction ? 'Confirm Start?' : 'Start Game'}
                            </button>
                        ) : (
                            <button 
                                onClick={handleNextQuestion} 
                                className={`font-bold py-2 px-4 rounded-lg ${isConfirmingAction ? 'bg-green-700' : 'bg-green-500 hover:bg-green-600'} text-white`}
                                disabled={currentQuestionIndex >= QUESTIONS_DATA.length - 1}
                            >
                                {isConfirmingAction ? 'Confirm?' : `Next Question (${nextQuestionNumber})`}
                            </button>
                        )}
                        <button onClick={handleDeactivate} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg" disabled={!isGameStarted}>Deactivate</button>
                        <button onClick={onResetGame} className={`font-bold py-2 px-4 rounded-lg ${isResetting ? 'bg-red-700' : 'bg-red-500 hover:bg-red-600'} text-white`}>
                            {isResetting ? 'Confirm Reset?' : 'Reset Game'}
                        </button>
                    </div>
                    {gameState.activeQuestionId && (
                        <div className="mt-4 text-center bg-gray-800 p-4 rounded-lg">
                            <p className="font-bold text-cyan-400">Active Question: #{QUESTIONS_DATA[currentQuestionIndex]?.id} ({timeLeft}s left)</p>
                            <p className="text-sm mt-1">Correct Answer: {QUESTIONS_DATA[currentQuestionIndex]?.correctAnswer}</p>
                        </div>
                    )}
                </div>
            );
        };

        const AdminView = () => { /* ... same as before ... */ };

        const OrganizerView = () => { /* ... same as before ... */ };

        const PasswordScreen = ({ onLogin }) => { /* ... same as before ... */ };

        const App = () => { /* ... same as before ... */ };

        const renderApp = async () => { /* ... same as before ... */ };
        
        if (window.db) {
            renderApp();
        } else {
            document.addEventListener('firebase-ready', renderApp, { once: true });
        }

    </script>
</body>
</html>
