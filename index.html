<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equatino! Bingo App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f9fafb;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .bingo-cell {
            user-select: none;
            transition: all 0.2s ease-in-out;
        }
        .bingo-cell.marked {
            background-color: #06b6d4;
            transform: scale(0.9);
            color: #ffffff;
            font-weight: 900;
        }
        .bingo-cell.incorrect {
            background-color: #ef4444; /* Red for incorrect */
            color: #ffffff;
            font-weight: 900;
            cursor: not-allowed;
        }
        .bingo-cell.clickable:hover {
            background-color: #0891b2;
            transform: scale(1.05);
            cursor: pointer;
        }
        .admin-card .bingo-cell {
            font-size: 0.7rem;
            line-height: 1;
            font-weight: bold;
        }
        .admin-card .bingo-cell.marked {
             background-color: #f59e0b;
        }
        .admin-card .bingo-cell.incorrect {
             background-color: #b91c1c;
        }
        @keyframes bingo-animation {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .bingo-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .bingo-text {
            font-size: 10vw; font-weight: 900; color: #22d3ee;
            text-shadow: 0 0 10px #fff, 0 0 20px #22d3ee;
            animation: bingo-animation 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        .question-modal {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        .confirmation-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, query, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBP2pYBRM4Eri0AJr4iZ2P7b08Cs6pTrtg",
          authDomain: "qr-gen-637fb.firebaseapp.com",
          projectId: "qr-gen-637fb",
          storageBucket: "qr-gen-637fb.appspot.com",
          messagingSenderId: "146967798778",
          appId: "1:1469677a8778:web:55f179f4ae3f3916f6ba43",
          measurementId: "G-1F0XF63NJP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.firebase = {
            doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, query, writeBatch, deleteDoc, getDocs,
            signInAnonymously
        };
        
        document.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, StrictMode, useRef } = React;

        // --- GAME CONFIGURATION AND DATA ---
        const BINGO_MAX_NUMBER = 25;
        const QUESTION_TIME_LIMIT = 100; // 60s solve + 30s hint + 10s buffer
        const LINES_TO_WIN = 5;
        const ADMIN_PASSWORD = "equatino2025";

        const ALL_QUESTIONS = [
            { id: 1, text: "A number exceeds 4/7 of itself by 12. What is the number?", correctAnswer: "28", hint: "Let the number be x. The equation is x - (4/7)x = 12." },
            { id: 2, text: "In a right-angled triangle, if sin(A) = 3/5, what is the value of (sec(A) + tan(A))²?", correctAnswer: "4", hint: "Find cos(A) and tan(A) using the Pythagorean identity." },
            { id: 3, text: "Find the 2-digit palindrome number which is also a palindrome when doubled.", correctAnswer: "22", hint: "A 2-digit palindrome has the form 'aa'. Check numbers like 11, 22, 33..." },
            { id: 4, text: "Solve for x: 3^(x-18) = 243", correctAnswer: "23", hint: "243 is a power of 3. Express it as 3^n." },
            { id: 6, text: "A cube has a volume of 512 cubic units. What is the length of one of its edges?", correctAnswer: "8", hint: "The volume of a cube is the edge length cubed." },
            { id: 7, text: "If log₃(x) = 2, what is the value of log₃(x³) + log₃(√x)?", correctAnswer: "7", hint: "Use the logarithm properties: log(a^b) = b*log(a) and log(ab) = log(a) + log(b)." },
            { id: 8, "text": "A regular dodecagon has 12 sides. What is this number of sides minus 3?", correctAnswer: "9", hint: "The question asks for a simple subtraction." },
            { id: 9, text: "Calculate the value of: [ (2 * sin(60°)) / cos(30°) ] + cot(45°)", correctAnswer: "3", hint: "sin(60°) = cos(30°)." },
            { id: 10, text: "A sphere has a volume of (16384 * π) / 3 cubic units. What is its radius?", correctAnswer: "16", hint: "Volume of a sphere is (4/3)πr³." },
            { id: 11, text: "Find the mean of the numbers: 832, 1024, 1100, 900, 756, 980, 1040, 870, 998, 3500. Then, divide the result by 100.", correctAnswer: "12", hint: "Sum all the numbers and divide by the count (10)." },
            { id: 14, text: "A bag contains 2 red, 5 blue, and 8 green balls. In how many ways can you draw 1 red and 1 blue ball?", correctAnswer: "10", hint: "Use the multiplication principle: (ways to choose red) * (ways to choose blue)." },
            { id: 15, text: "Evaluate the expression: [((6 ÷ 3) + (4 − 2)) × 2] ÷ 8", correctAnswer: "1", hint: "Follow the order of operations (PEMDAS/BODMAS)." },
            { id: 17, text: "The lateral surface area of a cylinder is 176π square units. If its height is 8 units, what is its radius?", correctAnswer: "11", hint: "Lateral surface area of a cylinder is 2πrh." },
            { id: 18, text: "Ten years ago, a father was 4 times as old as his son. Their current age difference is 21 years. What is the son's current age?", correctAnswer: "17", hint: "Set up two linear equations with two variables (father's age and son's age)." },
            { id: 19, text: "What is the focal length of the parabola defined by the equation y² = 20x?", correctAnswer: "5", hint: "The standard form is y² = 4ax, where 'a' is the focal length." },
            { id: 20, text: "A 7-sided regular polygon (a heptagon) has how many diagonals?", correctAnswer: "14", hint: "The formula for diagonals in an n-sided polygon is n(n-3)/2." },
            { id: 21, text: "In a pie chart of monthly expenses, the angle for groceries is 72°. What percentage of the total expenses does this represent?", correctAnswer: "20", hint: "A full circle is 360°. The percentage is (72/360) * 100." },
            { id: 22, text: "If matrix A = [[2, 1], [3, 4]] is multiplied by the identity matrix I = [[1, 0], [0, 1]], what is the top-left element of the resulting matrix?", correctAnswer: "2", hint: "Any matrix multiplied by the identity matrix results in the original matrix." },
            { id: 24, text: "A library has 95,000 books. If 0.02% of them are rare ancient manuscripts, how many rare manuscripts are there?", correctAnswer: "19", hint: "0.02% is equivalent to 0.0002 as a decimal." }
        ];
        
        const createFinalQuestionOrder = () => {
            const fixedAnswers = ["13", "18", "8", "15", "25", "6"];
            
            const finalFixedQuestions = [
                { id: 5, text: "What is the smallest prime number greater than 11?", correctAnswer: "13", hint: "Check numbers 12, 13, 14, 15..." },
                { id: 13, text: "What is 3 multiplied by 6?", correctAnswer: "18", hint: "This is a simple multiplication." },
                ALL_QUESTIONS.find(q => q.correctAnswer === "8"),
                { id: 23, text: "Calculate the value of: 5 * sin(30°) * csc(30°) * tan(60°) * cot(30°)", correctAnswer: "15", hint: "csc(x) is 1/sin(x) and cot(x) is 1/tan(x)." },
                { id: 16, text: "Compute the determinant of the matrix [[2, 3, 1], [4, 1, 2], [1, 2, 3]] and then take its absolute value (remove the negative sign).", correctAnswer: "25", hint: "Use the standard formula for a 3x3 determinant." },
                { id: 12, text: "How many distinct positive divisors does the number 60 have?", correctAnswer: "6", hint: "The divisors are 1, 2, 3, 4, 5, 6, 10, 12, 15, 20, 30, 60." }
            ];

            let finalRemaining = ALL_QUESTIONS.filter(q => !fixedAnswers.includes(q.correctAnswer));
            
            for (let i = finalRemaining.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [finalRemaining[i], finalRemaining[j]] = [finalRemaining[j], finalRemaining[i]];
            }

            return [...finalFixedQuestions, ...finalRemaining];
        };

        const QUESTIONS_DATA = createFinalQuestionOrder();

        const winningCombos = [
            [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
            [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
            [0,6,12,18,24], [4,8,12,16,20]
        ];

        function createSeededRandom(seed) { /* ... same as before ... */ }

        const BingoAnimation = () => ( <div className="bingo-overlay fade-in"><div className="bingo-text">BINGO!</div></div> );

        const QuestionModal = ({ question, timeLeft }) => {
            if (!question) return null;
            
            const totalDuration = QUESTION_TIME_LIMIT;
            const progress = (timeLeft / totalDuration) * 100;
            
            let timerColor = 'bg-cyan-500';
            let showHint = false;
            
            if (timeLeft <= 10) {
                timerColor = 'bg-red-500 animate-pulse';
                showHint = true;
            } else if (timeLeft <= 40) { // 30s hint + 10s buffer
                timerColor = 'bg-yellow-500';
                showHint = true;
            }

            return (
                <div className="question-modal w-11/12 max-w-2xl bg-gray-900 border-2 border-cyan-500 rounded-lg p-6 shadow-2xl">
                    <h2 className="text-xl font-bold text-cyan-400 mb-2">Question #{question.id} is Active!</h2>
                    <p className="text-lg mb-4">{question.text}</p>
                    {showHint && <p className="text-yellow-300 text-sm mb-4"><span className="font-bold">Hint:</span> {question.hint}</p>}
                    <div className="w-full bg-gray-700 rounded-full h-2.5">
                       <div className={`h-2.5 rounded-full ${timerColor}`} style={{ width: `${progress}%`, transition: 'width 0.5s linear' }}></div>
                    </div>
                    <p className="text-center text-sm font-bold mt-2">{timeLeft}s remaining</p>
                </div>
            );
        };

        const ConfirmationModal = ({ submission, onConfirm, onCancel }) => { /* ... same as before ... */ };
        
        const ParticipantView = ({ seed }) => {
            const [card, setCard] = useState(null);
            const [gameState, setGameState] = useState({});
            const [isBingo, setIsBingo] = useState(false);
            const [timeLeft, setTimeLeft] = useState(0);
            const [confirmingSubmission, setConfirmingSubmission] = useState(null);

            useEffect(() => {
                const cardDocRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/equatino-cards/${seed}`);
                const unsubscribeCard = window.firebase.onSnapshot(cardDocRef, (doc) => {
                    if (doc.exists()) setCard(doc.data());
                });
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                const unsubscribeGameState = window.firebase.onSnapshot(gameStateRef, (doc) => {
                    if (doc.exists()) setGameState(doc.data());
                });
                return () => { unsubscribeCard(); unsubscribeGameState(); };
            }, [seed]);

            useEffect(() => {
                if (gameState.isTimerRunning && gameState.endTime) {
                    const updateTimer = () => {
                        const now = Date.now();
                        const end = gameState.endTime.toDate().getTime();
                        const secondsLeft = Math.max(0, Math.floor((end - now) / 1000));
                        setTimeLeft(secondsLeft);
                        if (secondsLeft === 0) clearInterval(timerInterval);
                    };
                    updateTimer();
                    const timerInterval = setInterval(updateTimer, 1000);
                    return () => clearInterval(timerInterval);
                } else if (gameState.pausedTime) {
                    setTimeLeft(gameState.pausedTime);
                }
            }, [gameState.isTimerRunning, gameState.endTime, gameState.pausedTime]);

            useEffect(() => {
                if (card?.markedIndices) {
                    const markedSet = new Set(card.markedIndices);
                    let lines = 0;
                    for (const combo of winningCombos) {
                        if (combo.every(index => markedSet.has(index))) {
                            lines++;
                        }
                    }
                    if (lines >= LINES_TO_WIN) {
                        setIsBingo(true);
                    } else {
                        setIsBingo(false);
                    }
                }
            }, [card?.markedIndices]);

            const handleAttemptClick = (boxNumber) => {
                if (card.attempts?.[gameState.activeQuestionId]) return;
                setConfirmingSubmission({ boxNumber });
            };

            const handleConfirmSubmit = async () => {
                if (!confirmingSubmission) return;
                const { boxNumber } = confirmingSubmission;
                const activeQuestionId = gameState.activeQuestionId;
                
                const question = QUESTIONS_DATA.find(q => q.id === activeQuestionId);
                const isCorrect = String(boxNumber) === question.correctAnswer;
                
                const cardDocRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/equatino-cards/${seed}`);
                const newMarks = new Set(card.markedIndices);
                const incorrectAttempts = card.incorrectAttempts || {};
                const cellIndex = card.cardNumbers.findIndex(n => n === boxNumber);

                if (isCorrect) {
                    if (cellIndex !== -1) newMarks.add(cellIndex);
                } else {
                    if (cellIndex !== -1) incorrectAttempts[activeQuestionId] = cellIndex;
                }

                await window.firebase.updateDoc(cardDocRef, {
                    [`attempts.${activeQuestionId}`]: boxNumber,
                    markedIndices: Array.from(newMarks),
                    incorrectAttempts: incorrectAttempts
                });
                setConfirmingSubmission(null);
            };

            const renderCell = (cellIndex) => {
                const number = card.cardNumbers[cellIndex];
                const isMarked = card.markedIndices?.includes(cellIndex);
                const isIncorrect = card.incorrectAttempts?.[gameState.activeQuestionId] === cellIndex;
                const isQuestionActive = gameState.isTimerRunning && timeLeft > 0 && gameState.activeQuestionId && !card.attempts?.[gameState.activeQuestionId];
                
                if (isMarked) {
                    return <div key={cellIndex} className="bingo-cell marked flex items-center justify-center text-xl md:text-2xl font-bold rounded-md">{number}</div>;
                }
                
                if (isIncorrect) {
                     return <div key={cellIndex} className="bingo-cell incorrect flex items-center justify-center text-xl md:text-2xl font-bold rounded-md">{number}</div>;
                }

                if (isQuestionActive) {
                    return (
                        <div 
                            key={cellIndex} 
                            className="bingo-cell clickable flex items-center justify-center text-xl md:text-2xl font-bold rounded-md bg-gray-900"
                            onClick={() => handleAttemptClick(number)}
                        >
                            {number}
                        </div>
                    );
                }

                return <div key={cellIndex} className={`bingo-cell flex items-center justify-center text-xl md:text-2xl font-bold rounded-md bg-gray-900`}>{number}</div>;
            };
            
            if (!card?.cardNumbers) return <div>Loading Card...</div>;

            return (
                <div className="w-full max-w-md mx-auto text-center">
                    {isBingo && <BingoAnimation />}
                    <ConfirmationModal submission={confirmingSubmission} onConfirm={handleConfirmSubmit} onCancel={() => setConfirmingSubmission(null)} />
                    <QuestionModal question={QUESTIONS_DATA.find(q => q.id === Number(gameState.activeQuestionId))} timeLeft={timeLeft} />
                    <div className="mb-4">
                        <h1 className="text-5xl font-black tracking-tight text-cyan-400">Equatino!</h1>
                        <p className="text-gray-400 mt-1">Team: {card.teamName || 'N/A'}</p>
                    </div>
                    <div className="fade-in grid grid-cols-5 gap-2 bg-gray-800 p-3 rounded-lg shadow-2xl w-full aspect-square">
                        {Array.from({ length: 25 }).map((_, i) => renderCell(i))}
                    </div>
                </div>
            );
        };

        const AdminBingoCard = ({ numbers, markedIndices, incorrectAttempts, activeQuestionId }) => {
            const markedSet = new Set(markedIndices || []);
            const incorrectIndex = incorrectAttempts?.[activeQuestionId];
            return (
                <div className="admin-card grid grid-cols-5 gap-1 p-1 bg-gray-800 rounded-md mt-2">
                    {numbers.map((number, i) => {
                        const isMarked = markedSet.has(i);
                        const isIncorrect = i === incorrectIndex;
                        let cellClass = 'bg-gray-700';
                        if (isMarked) cellClass = 'marked';
                        if (isIncorrect) cellClass = 'incorrect';
                        return <div key={i} className={`bingo-cell flex items-center justify-center rounded aspect-square ${cellClass}`}>{number}</div>;
                    })}
                </div>
            );
        };
        
        const GameControlPanel = ({ onResetGame, isResetting }) => {
            const [gameState, setGameState] = useState({ questionIndex: -1 });
            const [timeLeft, setTimeLeft] = useState(0);
            const [isConfirmingAction, setIsConfirmingAction] = useState(false);

            useEffect(() => {
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                const unsubscribe = window.firebase.onSnapshot(gameStateRef, (doc) => {
                    if(doc.exists()) {
                        setGameState(doc.data());
                    } else {
                        setGameState({ activeQuestionId: null, questionIndex: -1, isTimerRunning: false });
                    }
                });
                return () => unsubscribe();
            }, []);

             useEffect(() => {
                if (gameState && gameState.isTimerRunning && gameState.endTime) {
                    const updateTimer = () => {
                        const now = Date.now();
                        const end = gameState.endTime.toDate().getTime();
                        const secondsLeft = Math.max(0, Math.floor((end - now) / 1000));
                        setTimeLeft(secondsLeft);
                        if (secondsLeft === 0) clearInterval(timerInterval);
                    };
                    updateTimer();
                    const timerInterval = setInterval(updateTimer, 1000);
                    return () => clearInterval(timerInterval);
                } else if (gameState.pausedTime) {
                    setTimeLeft(gameState.pausedTime);
                }
            }, [gameState.isTimerRunning, gameState.endTime, gameState.pausedTime]);
            
            const handleNextQuestion = async () => {
                const currentIndex = gameState.questionIndex ?? -1;
                const nextIndex = currentIndex + 1;
                if (nextIndex >= QUESTIONS_DATA.length) { alert("End of questions!"); return; }

                const nextQuestion = QUESTIONS_DATA[nextIndex];
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                await window.firebase.setDoc(gameStateRef, {
                    activeQuestionId: nextQuestion.id,
                    questionIndex: nextIndex,
                    isTimerRunning: false,
                    endTime: null,
                    pausedTime: QUESTION_TIME_LIMIT
                }, { merge: true });
            };

            const handleStartTimer = async () => {
                const endTime = new Date(Date.now() + (gameState.pausedTime || QUESTION_TIME_LIMIT) * 1000);
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                await window.firebase.updateDoc(gameStateRef, { isTimerRunning: true, endTime: endTime, pausedTime: null });
            };

            const handleStopTimer = async () => {
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                await window.firebase.updateDoc(gameStateRef, { isTimerRunning: false, pausedTime: timeLeft });
            };
            
            const currentQuestionIndex = gameState.questionIndex ?? -1;
            const isGameStarted = currentQuestionIndex > -1;
            const isGameFinished = currentQuestionIndex >= QUESTIONS_DATA.length -1;

            return (
                <div className="bg-gray-900 p-4 rounded-lg mb-6 shadow-lg">
                    <h2 className="text-2xl font-bold text-center mb-4">Game Controls</h2>
                    <div className="flex flex-wrap items-center justify-center gap-4">
                        {!isGameStarted ? (
                            <button onClick={handleNextQuestion} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Load First Question</button>
                        ) : (
                            <>
                                <button onClick={handleNextQuestion} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" disabled={isGameFinished}>Next Question</button>
                                {gameState.isTimerRunning ? (
                                    <button onClick={handleStopTimer} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Stop Timer</button>
                                ) : (
                                    <button onClick={handleStartTimer} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Start / Resume Timer</button>
                                )}
                            </>
                        )}
                        <button onClick={onResetGame} className={`font-bold py-2 px-4 rounded-lg ${isResetting ? 'bg-red-700' : 'bg-red-500 hover:bg-red-600'} text-white`}>
                            {isResetting ? 'Confirm Reset?' : 'Reset Game'}
                        </button>
                    </div>
                    {isGameStarted && (
                        <div className="mt-4 text-center bg-gray-800 p-4 rounded-lg">
                            <p className="font-bold text-cyan-400">Current Question: #{QUESTIONS_DATA[currentQuestionIndex]?.id} ({timeLeft}s left)</p>
                            <p className="text-sm mt-1">Correct Answer: {QUESTIONS_DATA[currentQuestionIndex]?.correctAnswer}</p>
                        </div>
                    )}
                </div>
            );
        };

        const AdminView = () => {
            const [cards, setCards] = useState([]);
            const [loading, setLoading] = useState(true);
            const [gameState, setGameState] = useState({});
            const [confirmingDelete, setConfirmingDelete] = useState(null);
            const [confirmingReset, setConfirmingReset] = useState(false);

            useEffect(() => {
                const cardsCollectionRef = window.firebase.collection(window.db, `/artifacts/${window.appId}/public/data/equatino-cards`);
                const q = window.firebase.query(cardsCollectionRef);
                const unsubscribeCards = window.firebase.onSnapshot(q, (querySnapshot) => {
                    const cardsData = [];
                    querySnapshot.forEach((doc) => {
                        cardsData.push({ id: doc.id, ...doc.data() });
                    });
                    cardsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setCards(cardsData);
                    setLoading(false);
                });

                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                const unsubscribeGameState = window.firebase.onSnapshot(gameStateRef, (doc) => {
                    if (doc.exists()) setGameState(doc.data());
                });

                return () => { unsubscribeCards(); unsubscribeGameState(); };
            }, []);

            const handleTeamNameChange = (cardId, newName) => {
                const cardDocPath = `/artifacts/${window.appId}/public/data/equatino-cards/${cardId}`;
                window.firebase.updateDoc(window.firebase.doc(window.db, cardDocPath), { teamName: newName });
            };

            const handleDeleteTeam = async (cardId) => {
                if (confirmingDelete !== cardId) {
                    setConfirmingDelete(cardId);
                    setTimeout(() => setConfirmingDelete(null), 3000);
                    return;
                }
                const cardDocRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/equatino-cards/${cardId}`);
                await window.firebase.deleteDoc(cardDocRef);
                setConfirmingDelete(null);
            };

            const handleResetGame = async () => {
                if (!confirmingReset) {
                    setConfirmingReset(true);
                    setTimeout(() => setConfirmingReset(false), 3000);
                    return;
                }
                
                const cardsCollectionRef = window.firebase.collection(window.db, `/artifacts/${window.appId}/public/data/equatino-cards`);
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                
                const batch = window.firebase.writeBatch(window.db);
                const snapshot = await window.firebase.getDocs(cardsCollectionRef);
                snapshot.forEach(doc => batch.delete(doc.ref));
                batch.delete(gameStateRef);
                
                await batch.commit();
                setConfirmingReset(false);
            };

            const scores = cards.map(card => card.markedIndices?.length || 0);
            const maxScore = scores.length > 0 ? Math.max(...scores) : 0;

            if (loading) return <div>Loading Admin Panel...</div>;

            return (
                <div className="w-full max-w-7xl mx-auto text-center p-4">
                    <h1 className="text-4xl font-bold text-cyan-400 mb-6">Admin Dashboard</h1>
                    <GameControlPanel onResetGame={handleResetGame} isResetting={confirmingReset} />
                    {cards.length === 0 && <p className="text-gray-500 py-4 bg-gray-800 rounded-lg">No cards have been generated yet.</p>}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {cards.map(card => {
                            const isLeader = (card.markedIndices?.length || 0) === maxScore && maxScore > 0;
                            const leaderClass = isLeader ? 'ring-2 ring-amber-400 shadow-lg' : '';
                            const isConfirming = confirmingDelete === card.id;

                            return (
                                <div key={card.id} className={`bg-gray-800 rounded-lg shadow-xl p-4 transition-all ${leaderClass}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <input
                                            type="text"
                                            defaultValue={card.teamName || ''}
                                            onBlur={(e) => handleTeamNameChange(card.id, e.target.value)}
                                            placeholder="Enter team name..."
                                            className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        />
                                        <button 
                                            onClick={() => handleDeleteTeam(card.id)} 
                                            className={`ml-2 px-3 py-1 text-sm font-bold text-white rounded ${isConfirming ? 'bg-red-700' : 'bg-red-500 hover:bg-red-600'}`}
                                        >
                                            {isConfirming ? 'Confirm?' : 'Del'}
                                        </button>
                                    </div>
                                    {card.cardNumbers && <AdminBingoCard numbers={card.cardNumbers} markedIndices={card.markedIndices} incorrectAttempts={card.incorrectAttempts} activeQuestionId={gameState.activeQuestionId} />}
                                    <p className="text-xs text-gray-500 mt-2 font-mono">{card.id}</p>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const OrganizerView = () => {
             const [generatedUrl, setGeneratedUrl] = useState('');
             const [showQr, setShowQr] = useState(false);

             useEffect(() => {
                 if (generatedUrl) {
                     const qrcodeDiv = document.getElementById('qrcode');
                     if (qrcodeDiv) {
                         qrcodeDiv.innerHTML = ''; 
                         new QRCode(qrcodeDiv, { text: generatedUrl, width: 256, height: 256 });
                     }
                 }
             }, [generatedUrl]);

             const handleGenerateLink = () => {
                 const newSeed = Math.random().toString(36).substring(2, 10);
                 const baseUrl = window.location.href.split('?')[0];
                 const newUrl = `${baseUrl}?seed=${newSeed}`;

                 setGeneratedUrl(newUrl);
                 setShowQr(true);

                 const randomFunc = createSeededRandom(newSeed);
                 const allQuestionNumbers = QUESTIONS_DATA.map(q => q.id);
                 
                 for (let i = allQuestionNumbers.length - 1; i > 0; i--) {
                    const j = randomFunc() % (i + 1);
                    [allQuestionNumbers[i], allQuestionNumbers[j]] = [allQuestionNumbers[j], allQuestionNumbers[i]];
                 }
                 const cardNumbers = allQuestionNumbers.slice(0, 25);

                 const cardDocPath = `/artifacts/${window.appId}/public/data/equatino-cards/${newSeed}`;
                 
                 window.firebase.setDoc(window.firebase.doc(window.db, cardDocPath), {
                     seed: newSeed,
                     teamName: "",
                     cardNumbers: cardNumbers,
                     markedIndices: [],
                     attempts: {},
                     incorrectAttempts: {},
                     createdAt: window.firebase.serverTimestamp()
                 }).catch(error => {
                     console.error("Error saving card to Firestore:", error);
                 });
             };

             return (
                 <div className="w-full max-w-md mx-auto text-center mt-10">
                     <h1 className="text-3xl font-bold text-cyan-400">Organizer Panel</h1>
                     <p className="text-gray-400 mb-6">Generate a unique QR code for participants</p>
                     <button onClick={handleGenerateLink} className="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg">
                         Generate New QR Code
                     </button>
                     
                     {showQr && (
                         <div id="qr-code-container" className="mt-6 p-4 border-2 border-dashed border-gray-700 rounded-lg fade-in">
                             <p className="text-gray-400 mb-2 text-sm">Project this QR code</p>
                             <div id="qrcode" className="flex justify-center bg-white p-4 rounded-md mx-auto w-fit"></div>
                             <div className="mt-4">
                                 <p className="text-gray-400 text-sm">Or share this link:</p>
                                 <input type="text" className="w-full bg-gray-700 rounded p-2 mt-1 text-center" value={generatedUrl} readOnly />
                             </div>
                         </div>
                     )}
                 </div>
             );
        };

        const PasswordScreen = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === ADMIN_PASSWORD) {
                    onLogin();
                } else {
                    setError('Incorrect password');
                    setPassword('');
                }
            };

            return (
                <div className="flex items-center justify-center h-screen">
                    <form onSubmit={handleSubmit} className="bg-gray-800 p-8 rounded-lg shadow-lg text-center">
                        <h2 className="text-2xl font-bold text-cyan-400 mb-4">Admin Access</h2>
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            placeholder="Enter password..."
                            className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                        />
                        {error && <p className="text-red-500 mt-2">{error}</p>}
                        <button type="submit" className="mt-4 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">
                            Login
                        </button>
                    </form>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('loading');
            const [seed, setSeed] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('seed')) {
                    setSeed(urlParams.get('seed'));
                    setView('participant');
                } else if (urlParams.has('admin')) {
                    setView('admin');
                } else {
                    setView('organizer');
                }
            }, []);

            if (view === 'participant') {
                return <ParticipantView seed={seed} />;
            }

            if (view === 'organizer' || view === 'admin') {
                if (!isAuthenticated) {
                    return <PasswordScreen onLogin={() => setIsAuthenticated(true)} />;
                }
                switch (view) {
                    case 'admin': return <AdminView />;
                    case 'organizer': return <OrganizerView />;
                }
            }
            
            return <div className="text-center mt-10">Loading...</div>;
        };

        const renderApp = async () => {
            try {
                await window.firebase.signInAnonymously(window.auth);
            } catch (error) {
                console.error("Authentication failed:", error);
            }
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<StrictMode><App /></StrictMode>);
        };
        
        if (window.db) {
            renderApp();
        } else {
            document.addEventListener('firebase-ready', renderApp, { once: true });
        }

    </script>
</body>
</html>
