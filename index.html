<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equatino! Bingo App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f9fafb;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .bingo-cell {
            user-select: none;
            transition: all 0.2s ease-in-out;
        }
        .bingo-cell.marked {
            background-color: #06b6d4;
            transform: scale(0.9);
            color: #ffffff;
            font-weight: 900;
        }
        .admin-card .bingo-cell {
            font-size: 0.7rem;
            line-height: 1;
            font-weight: bold;
        }
        .admin-card .bingo-cell.marked {
             background-color: #f59e0b;
        }
        @keyframes bingo-animation {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .bingo-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .bingo-text {
            font-size: 10vw; font-weight: 900; color: #22d3ee;
            text-shadow: 0 0 10px #fff, 0 0 20px #22d3ee;
            animation: bingo-animation 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        .question-modal {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, query, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBP2pYBRM4Eri0AJr4iZ2P7b08Cs6pTrtg",
          authDomain: "qr-gen-637fb.firebaseapp.com",
          projectId: "qr-gen-637fb",
          storageBucket: "qr-gen-637fb.appspot.com",
          messagingSenderId: "146967798778",
          appId: "1:146967798778:web:55f179f4ae3f3916f6ba43",
          measurementId: "G-1F0XF63NJP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.firebase = {
            doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, query, writeBatch, deleteDoc, getDocs,
            signInAnonymously
        };
        
        document.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, StrictMode, useRef } = React;

        // --- GAME CONFIGURATION AND DATA ---
        const BINGO_MAX_NUMBER = 30;
        const QUESTION_TIME_LIMIT = 120;

        // --- Central Question Bank with Direct Answers ---
        const QUESTIONS_DATA = [
            { id: 1, text: "In a room of 10 people, if everyone shakes hands with everyone else exactly once, how many handshakes occur in total?", correctAnswer: "45" },
            { id: 2, text: "What is the next number in the sequence: 1, 4, 9, 16, 25, ...?", correctAnswer: "36" },
            { id: 3, text: "If f(x) = x^2 + 2x, what is the value of f'(1)?", correctAnswer: "4" },
            { id: 4, text: "What is the value of the imaginary unit i raised to the power of 100? (i^100)", correctAnswer: "1" },
            { id: 5, text: "A single six-sided die is rolled. What is the probability of rolling a number greater than 4? (Enter as a fraction, e.g., 1/3)", correctAnswer: "1/3" },
            { id: 6, text: "A father's age is currently three times his son's age. Four years ago, he was four times as old as his son. What is the father's current age?", correctAnswer: "36" },
            { id: 7, text: "What is the value of the definite integral of 2x from 0 to 1?", correctAnswer: "1" },
            { id: 8, text: "Which famous mathematician is credited with the invention of the coordinate system?", correctAnswer: "Descartes" },
            { id: 9, text: "If a circle has a radius of 5 units, what is its area? (Enter number only, e.g., 25pi)", correctAnswer: "25pi" },
            { id: 10, text: "What is the determinant of the matrix [[3, 1], [4, 2]]?", correctAnswer: "2" },
            { id: 11, text: "What is the angle in degrees between the hour and minute hands of a clock at 3:00?", correctAnswer: "90" },
            { id: 12, text: "If log base 10 of x = 2, what is the value of x?", correctAnswer: "100" },
            { id: 13, text: "The value of sin^2(theta) + cos^2(theta) is always:", correctAnswer: "1" },
            { id: 14, text: "How many ways can you arrange the letters of the word 'MATH'?", correctAnswer: "24" },
            { id: 15, text: "Find the slope of the line passing through the points (1, 2) and (3, 6).", correctAnswer: "2" },
            { id: 16, text: "What is the approximate value of the golden ratio, phi, to 3 decimal places?", correctAnswer: "1.618" },
            { id: 17, text: "A bag has 5 red and 3 blue balls. What is the probability of picking a blue ball? (Enter as fraction e.g. 3/8)", correctAnswer: "3/8" },
            { id: 18, text: "What is the next term in the 'Look-and-Say' sequence: 1, 11, 21, 1211, ...?", correctAnswer: "111221" },
            { id: 19, text: "What is the sum of the first 10 positive integers (1+2+...+10)?", correctAnswer: "55" },
            { id: 20, text: "What is the dot product of the vectors 2i + 3j and 4i - 2j?", correctAnswer: "2" },
            { id: 21, text: "A farmer has 17 sheep. All but 9 die. How many are left?", correctAnswer: "9" },
            { id: 22, text: "The eccentricity of any circle is always:", correctAnswer: "0" },
            { id: 23, text: "If A+B=5 and A-B=1, what is the value of A?", correctAnswer: "3" },
            { id: 24, text: "What is the smallest prime number?", correctAnswer: "2" },
            { id: 25, text: "The general solution of the differential equation dy/dx = 1 is y = x + C. What letter represents the constant of integration?", correctAnswer: "C" },
            { id: 26, text: "A triangle has angles 30, 60, and 90 degrees. What is this type of triangle called?", correctAnswer: "Right-angled" },
            { id: 27, text: "The value of 0! (zero factorial) is:", correctAnswer: "1" },
            { id: 28, text: "If you flip a fair coin twice, what is the probability of getting two heads (HH)? (Enter as fraction e.g. 1/4)", correctAnswer: "1/4" },
            { id: 29, text: "What is the sum of the angles in any triangle, in degrees?", correctAnswer: "180" },
            { id: 30, text: "In the puzzle ME + ME = BEE, what number does 'E' represent?", correctAnswer: "9" }
        ];

        const winningCombos = [
            [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
            [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
            [0,6,12,18,24], [4,8,12,16,20]
        ];

        // --- HELPER FUNCTIONS ---
        function createSeededRandom(seed) {
            let h = 1779033703 ^ seed.length;
            for (let i = 0; i < seed.length; i++) {
                h = Math.imul(h ^ seed.charCodeAt(i), 3432918353);
                h = h << 13 | h >>> 19;
            }
            return function() {
                h = Math.imul(h ^ h >>> 16, 2246822507);
                h = Math.imul(h ^ h >>> 13, 3266489909);
                return (h ^= h >>> 16) >>> 0;
            }
        }

        /**
         * Compares a submitted answer with the correct answer, normalizing for common formatting issues.
         * @param {string} submitted - The user's submitted answer.
         * @param {string} correct - The correct answer from the database.
         * @returns {boolean} - True if the answers are considered equivalent.
         */
        function isAnswerCorrect(submitted, correct) {
            if (typeof submitted !== 'string' || typeof correct !== 'string') {
                return false;
            }

            // Step 1: Normalize both strings (trim whitespace, convert to lowercase)
            const normalizedSubmitted = submitted.trim().toLowerCase();
            const normalizedCorrect = correct.trim().toLowerCase();

            // Step 2: Direct comparison for simple cases
            if (normalizedSubmitted === normalizedCorrect) {
                return true;
            }

            // Step 3: Attempt numerical comparison
            const submittedNum = parseFloat(normalizedSubmitted);
            const correctNum = parseFloat(normalizedCorrect);

            // If both are valid numbers, compare them
            if (!isNaN(submittedNum) && !isNaN(correctNum) && submittedNum === correctNum) {
                return true;
            }
            
            // Handle special string cases like "25pi" vs "25 pi"
            if (normalizedSubmitted.replace(/\s/g, '') === normalizedCorrect.replace(/\s/g, '')) {
                return true;
            }

            return false;
        }


        // --- SHARED COMPONENTS ---
        const BingoAnimation = () => ( <div className="bingo-overlay fade-in"><div className="bingo-text">BINGO!</div></div> );

        // --- PARTICIPANT VIEW ---
        const QuestionModal = ({ question, timeLeft, activeQuestionId }) => {
            if (!question) return null;
            const progress = (timeLeft / QUESTION_TIME_LIMIT) * 100;
            return (
                <div className="question-modal w-11/12 max-w-2xl bg-gray-900 border-2 border-cyan-500 rounded-lg p-6 shadow-2xl">
                    <h2 className="text-xl font-bold text-cyan-400 mb-2">Question #{activeQuestionId} is Active!</h2>
                    <p className="text-lg mb-4">{question.text}</p>
                    <div className="w-full bg-gray-700 rounded-full h-2.5">
                       <div className="bg-cyan-500 h-2.5 rounded-full" style={{ width: `${progress}%`, transition: 'width 0.5s linear' }}></div>
                    </div>
                    <p className="text-center text-sm font-bold mt-2">{timeLeft}s remaining</p>
                </div>
            );
        };
        
        const ParticipantView = ({ seed }) => {
            const [card, setCard] = useState(null);
            const [gameState, setGameState] = useState({});
            const [isBingo, setIsBingo] = useState(false);
            const [timeLeft, setTimeLeft] = useState(0);

            useEffect(() => {
                const cardDocRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/equatino-cards/${seed}`);
                const unsubscribeCard = window.firebase.onSnapshot(cardDocRef, (doc) => {
                    if (doc.exists()) setCard(doc.data());
                });

                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                const unsubscribeGameState = window.firebase.onSnapshot(gameStateRef, (doc) => {
                    if (doc.exists()) setGameState(doc.data());
                });

                return () => {
                    unsubscribeCard();
                    unsubscribeGameState();
                };
            }, [seed]);

            useEffect(() => {
                if (gameState.endTime) {
                    const updateTimer = () => {
                        const now = Date.now();
                        const end = gameState.endTime.toDate().getTime();
                        const secondsLeft = Math.max(0, Math.floor((end - now) / 1000));
                        setTimeLeft(secondsLeft);
                        if (secondsLeft === 0) clearInterval(timerInterval);
                    };
                    updateTimer();
                    const timerInterval = setInterval(updateTimer, 1000);
                    return () => clearInterval(timerInterval);
                }
            }, [gameState.endTime]);

            useEffect(() => {
                if (card?.markedIndices) {
                    const markedSet = new Set(card.markedIndices);
                    if (winningCombos.some(combo => combo.every(index => markedSet.has(index)))) {
                        setIsBingo(true);
                    } else {
                        setIsBingo(false);
                    }
                }
            }, [card?.markedIndices]);

            const handleSubmitAnswer = async (questionId, submittedAnswer) => {
                if (!submittedAnswer || card.attempts?.[questionId]) return;

                const question = QUESTIONS_DATA.find(q => q.id === questionId);
                const correct = isAnswerCorrect(submittedAnswer, question.correctAnswer);
                
                const cardDocRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/equatino-cards/${seed}`);
                const newMarks = new Set(card.markedIndices);
                if (correct) {
                    const cellIndex = card.cardNumbers.findIndex(n => n === questionId);
                    if (cellIndex !== -1) {
                        newMarks.add(cellIndex);
                    }
                }

                await window.firebase.updateDoc(cardDocRef, {
                    [`attempts.${questionId}`]: submittedAnswer,
                    markedIndices: Array.from(newMarks)
                });
            };

            const renderCell = (cellIndex) => {
                const number = card.cardNumbers[cellIndex];
                const isMarked = card.markedIndices?.includes(cellIndex);
                const isActive = Number(gameState.activeQuestionId) === number && timeLeft > 0;
                const wasAttempted = card.attempts?.[number];

                if (isMarked) {
                    return <div key={cellIndex} className="bingo-cell marked flex items-center justify-center text-xl md:text-2xl font-bold rounded-md">{number}</div>;
                }
                
                if (isActive && !wasAttempted) {
                    return (
                        <form key={cellIndex} onSubmit={(e) => { e.preventDefault(); handleSubmitAnswer(number, e.target.answer.value); }}>
                            <input
                                name="answer"
                                type="text"
                                className="w-full h-full bg-cyan-200 text-gray-900 text-2xl font-bold text-center rounded-md focus:outline-none focus:ring-4 ring-cyan-500"
                                autoFocus
                            />
                        </form>
                    );
                }

                const cellColor = wasAttempted ? 'bg-gray-700 text-gray-500' : 'bg-gray-900';
                return <div key={cellIndex} className={`bingo-cell flex items-center justify-center text-xl md:text-2xl font-bold rounded-md ${cellColor}`}>{number}</div>;
            };
            
            if (!card?.cardNumbers) return <div>Loading Card...</div>;

            return (
                <div className="w-full max-w-md mx-auto text-center">
                    {isBingo && <BingoAnimation />}
                    <QuestionModal question={QUESTIONS_DATA.find(q => q.id === Number(gameState.activeQuestionId))} timeLeft={timeLeft} activeQuestionId={gameState.activeQuestionId} />
                    <div className="mb-4">
                        <h1 className="text-5xl font-black tracking-tight text-cyan-400">Equatino!</h1>
                        <p className="text-gray-400 mt-1">Team: {card.teamName || 'N/A'}</p>
                    </div>
                    <div className="fade-in grid grid-cols-5 gap-2 bg-gray-800 p-3 rounded-lg shadow-2xl w-full aspect-square">
                        {Array.from({ length: 25 }).map((_, i) => renderCell(i))}
                    </div>
                </div>
            );
        };

        // --- ADMIN VIEW ---
        const AdminBingoCard = ({ numbers, markedIndices }) => {
            const markedSet = new Set(markedIndices || []);
            return (
                <div className="admin-card grid grid-cols-5 gap-1 p-1 bg-gray-800 rounded-md mt-2">
                    {numbers.map((number, i) => {
                        const isMarked = markedSet.has(i);
                        return <div key={i} className={`bingo-cell flex items-center justify-center rounded bg-gray-700 aspect-square ${isMarked ? 'marked' : ''}`}>{number}</div>;
                    })}
                </div>
            );
        };
        
        const GameControlPanel = ({ onResetGame, isResetting }) => {
            const [selectedQuestion, setSelectedQuestion] = useState(1);
            const [gameState, setGameState] = useState({});
            const [timeLeft, setTimeLeft] = useState(0);

            useEffect(() => {
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                const unsubscribe = window.firebase.onSnapshot(gameStateRef, (doc) => {
                    if(doc.exists()) setGameState(doc.data());
                });
                return () => unsubscribe();
            }, []);

             useEffect(() => {
                if (gameState.endTime) {
                    const updateTimer = () => {
                        const now = Date.now();
                        const end = gameState.endTime.toDate().getTime();
                        const secondsLeft = Math.max(0, Math.floor((end - now) / 1000));
                        setTimeLeft(secondsLeft);
                        if (secondsLeft === 0) clearInterval(timerInterval);
                    };
                    updateTimer();
                    const timerInterval = setInterval(updateTimer, 1000);
                    return () => clearInterval(timerInterval);
                } else {
                    setTimeLeft(0);
                }
            }, [gameState.endTime]);
            
            const handleActivate = async () => {
                const endTime = new Date(Date.now() + QUESTION_TIME_LIMIT * 1000);
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                await window.firebase.setDoc(gameStateRef, {
                    activeQuestionId: parseInt(selectedQuestion),
                    endTime: endTime
                }, { merge: true });
            };

            const handleDeactivate = async () => {
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                await window.firebase.updateDoc(gameStateRef, { activeQuestionId: null, endTime: null });
            };

            return (
                <div className="bg-gray-900 p-4 rounded-lg mb-6 shadow-lg">
                    <h2 className="text-2xl font-bold text-center mb-4">Game Controls</h2>
                    <div className="flex flex-wrap items-center justify-center gap-4">
                        <select
                            value={selectedQuestion}
                            onChange={(e) => setSelectedQuestion(e.target.value)}
                            className="bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                        >
                            {QUESTIONS_DATA.map(q => <option key={q.id} value={q.id}>Question #{q.id}</option>)}
                        </select>
                        <button onClick={handleActivate} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Activate</button>
                        <button onClick={handleDeactivate} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Deactivate</button>
                        <button onClick={onResetGame} className={`font-bold py-2 px-4 rounded-lg ${isResetting ? 'bg-red-700 text-white' : 'bg-red-500 hover:bg-red-600 text-white'}`}>
                            {isResetting ? 'Confirm Reset?' : 'Reset Game'}
                        </button>
                    </div>
                    {gameState.activeQuestionId && (
                        <div className="mt-4 text-center bg-gray-800 p-4 rounded-lg">
                            <p className="font-bold text-cyan-400">Active Question: #{gameState.activeQuestionId} ({timeLeft}s left)</p>
                            <p className="text-sm mt-1">Correct Answer: {QUESTIONS_DATA.find(q => q.id === Number(gameState.activeQuestionId))?.correctAnswer}</p>
                        </div>
                    )}
                </div>
            );
        };

        const AdminView = () => {
            const [cards, setCards] = useState([]);
            const [loading, setLoading] = useState(true);
            const [confirmingDelete, setConfirmingDelete] = useState(null);
            const [confirmingReset, setConfirmingReset] = useState(false);

            useEffect(() => {
                const cardsCollectionRef = window.firebase.collection(window.db, `/artifacts/${window.appId}/public/data/equatino-cards`);
                const q = window.firebase.query(cardsCollectionRef);

                const unsubscribe = window.firebase.onSnapshot(q, (querySnapshot) => {
                    const cardsData = [];
                    querySnapshot.forEach((doc) => {
                        cardsData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    cardsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setCards(cardsData);
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore snapshot error:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const handleTeamNameChange = (cardId, newName) => {
                const cardDocPath = `/artifacts/${window.appId}/public/data/equatino-cards/${cardId}`;
                window.firebase.updateDoc(window.firebase.doc(window.db, cardDocPath), { teamName: newName });
            };

            const handleDeleteTeam = async (cardId) => {
                if (confirmingDelete !== cardId) {
                    setConfirmingDelete(cardId);
                    setTimeout(() => setConfirmingDelete(null), 3000);
                    return;
                }
                const cardDocRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/equatino-cards/${cardId}`);
                await window.firebase.deleteDoc(cardDocRef);
                setConfirmingDelete(null);
            };

            const handleResetGame = async () => {
                if (!confirmingReset) {
                    setConfirmingReset(true);
                    setTimeout(() => setConfirmingReset(false), 3000);
                    return;
                }
                
                const cardsCollectionRef = window.firebase.collection(window.db, `/artifacts/${window.appId}/public/data/equatino-cards`);
                const gameStateRef = window.firebase.doc(window.db, `/artifacts/${window.appId}/public/data/game-state/current`);
                
                const batch = window.firebase.writeBatch(window.db);
                const snapshot = await window.firebase.getDocs(cardsCollectionRef);
                snapshot.forEach(doc => batch.delete(doc.ref));
                batch.delete(gameStateRef);
                
                await batch.commit();
                setConfirmingReset(false);
            };

            const scores = cards.map(card => card.markedIndices?.length || 0);
            const maxScore = scores.length > 0 ? Math.max(...scores) : 0;

            if (loading) return <div>Loading Admin Panel...</div>;

            return (
                <div className="w-full max-w-7xl mx-auto text-center p-4">
                    <h1 className="text-4xl font-bold text-cyan-400 mb-6">Admin Dashboard</h1>
                    <GameControlPanel onResetGame={handleResetGame} isResetting={confirmingReset} />
                    {cards.length === 0 && <p className="text-gray-500 py-4 bg-gray-800 rounded-lg">No cards have been generated yet.</p>}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {cards.map(card => {
                            const isLeader = (card.markedIndices?.length || 0) === maxScore && maxScore > 0;
                            const leaderClass = isLeader ? 'ring-2 ring-amber-400 shadow-lg' : '';
                            const isConfirming = confirmingDelete === card.id;

                            return (
                                <div key={card.id} className={`bg-gray-800 rounded-lg shadow-xl p-4 transition-all ${leaderClass}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <input
                                            type="text"
                                            defaultValue={card.teamName || ''}
                                            onBlur={(e) => handleTeamNameChange(card.id, e.target.value)}
                                            placeholder="Enter team name..."
                                            className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        />
                                        <button 
                                            onClick={() => handleDeleteTeam(card.id)} 
                                            className={`ml-2 px-3 py-1 text-sm font-bold text-white rounded ${isConfirming ? 'bg-red-700' : 'bg-red-500 hover:bg-red-600'}`}
                                        >
                                            {isConfirming ? 'Confirm?' : 'Del'}
                                        </button>
                                    </div>
                                    {card.cardNumbers && <AdminBingoCard numbers={card.cardNumbers} markedIndices={card.markedIndices} />}
                                    <p className="text-xs text-gray-500 mt-2 font-mono">{card.id}</p>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const OrganizerView = () => {
             const [generatedUrl, setGeneratedUrl] = useState('');
             const [showQr, setShowQr] = useState(false);

             useEffect(() => {
                 if (generatedUrl) {
                     const qrcodeDiv = document.getElementById('qrcode');
                     if (qrcodeDiv) {
                         qrcodeDiv.innerHTML = ''; 
                         new QRCode(qrcodeDiv, { text: generatedUrl, width: 256, height: 256 });
                     }
                 }
             }, [generatedUrl]);

             const handleGenerateLink = () => {
                 const newSeed = Math.random().toString(36).substring(2, 10);
                 const baseUrl = window.location.href.split('?')[0];
                 const newUrl = `${baseUrl}?seed=${newSeed}`;

                 setGeneratedUrl(newUrl);
                 setShowQr(true);

                 const randomFunc = createSeededRandom(newSeed);
                 const allQuestionNumbers = Array.from({ length: BINGO_MAX_NUMBER }, (_, i) => i + 1);
                 
                 for (let i = allQuestionNumbers.length - 1; i > 0; i--) {
                    const j = randomFunc() % (i + 1);
                    [allQuestionNumbers[i], allQuestionNumbers[j]] = [allQuestionNumbers[j], allQuestionNumbers[i]];
                 }
                 const cardNumbers = allQuestionNumbers.slice(0, 25);

                 const cardDocPath = `/artifacts/${window.appId}/public/data/equatino-cards/${newSeed}`;
                 
                 window.firebase.setDoc(window.firebase.doc(window.db, cardDocPath), {
                     seed: newSeed,
                     teamName: "",
                     cardNumbers: cardNumbers,
                     markedIndices: [],
                     attempts: {},
                     createdAt: window.firebase.serverTimestamp()
                 }).catch(error => {
                     console.error("Error saving card to Firestore:", error);
                 });
             };

             return (
                 <div className="w-full max-w-md mx-auto text-center mt-10">
                     <h1 className="text-3xl font-bold text-cyan-400">Organizer Panel</h1>
                     <p className="text-gray-400 mb-6">Generate a unique QR code for participants</p>
                     <button onClick={handleGenerateLink} className="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg">
                         Generate New QR Code
                     </button>
                     
                     {showQr && (
                         <div id="qr-code-container" className="mt-6 p-4 border-2 border-dashed border-gray-700 rounded-lg fade-in">
                             <p className="text-gray-400 mb-2 text-sm">Project this QR code</p>
                             <div id="qrcode" className="flex justify-center bg-white p-4 rounded-md mx-auto w-fit"></div>
                             <div className="mt-4">
                                 <p className="text-gray-400 text-sm">Or share this link:</p>
                                 <input type="text" className="w-full bg-gray-700 rounded p-2 mt-1 text-center" value={generatedUrl} readOnly />
                             </div>
                         </div>
                     )}
                 </div>
             );
        };

        const App = () => {
            const [view, setView] = useState('loading');
            const [seed, setSeed] = useState(null);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('seed')) {
                    setSeed(urlParams.get('seed'));
                    setView('participant');
                } else if (urlParams.has('admin')) {
                    setView('admin');
                } else {
                    setView('organizer');
                }
            }, []);

            switch (view) {
                case 'participant': return <ParticipantView seed={seed} />;
                case 'admin': return <AdminView />;
                case 'organizer': return <OrganizerView />;
                default: return <div className="text-center mt-10">Loading...</div>;
            }
        };

        const renderApp = async () => {
            try {
                await window.firebase.signInAnonymously(window.auth);
            } catch (error) {
                console.error("Authentication failed:", error);
            }
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<StrictMode><App /></StrictMode>);
        };
        
        if (window.db) {
            renderApp();
        } else {
            document.addEventListener('firebase-ready', renderApp, { once: true });
        }

    </script>
</body>
</html>
